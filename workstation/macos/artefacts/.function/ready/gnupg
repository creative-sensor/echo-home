set -x

ARTIFACT_DIR=$ARTIFACT_DIR/gnupg
mkdir -p $ARTIFACT_DIR

VERSION_libgpg_error=1.56
VERSION_libgcrypt=1.11.2
VERSION_libksba=1.6.7
VERSION_libassuan=3.0.2
VERSION_ntbtls=0.3.2
VERSION_npth=1.8
VERSION_pinentry=1.3.2

curl -s -L -o $ARTIFACT_DIR/gnupg-${ARTIFACT_VERSION}.tar.bz2   https://www.gnupg.org/ftp/gcrypt/gnupg/gnupg-${ARTIFACT_VERSION}.tar.bz2
curl -s -L -o $ARTIFACT_DIR/libgpg-error-${VERSION_libgpg_error}.tar.bz2   https://www.gnupg.org/ftp/gcrypt/libgpg-error/libgpg-error-${VERSION_libgpg_error}.tar.bz2
curl -s -L -o $ARTIFACT_DIR/libgcrypt-${VERSION_libgcrypt}.tar.bz2   https://www.gnupg.org/ftp/gcrypt/libgcrypt/libgcrypt-${VERSION_libgcrypt}.tar.bz2
curl -s -L -o $ARTIFACT_DIR/libksba-${VERSION_libksba}.tar.bz2   https://www.gnupg.org/ftp/gcrypt/libksba/libksba-${VERSION_libksba}.tar.bz2
curl -s -L -o $ARTIFACT_DIR/libassuan-${VERSION_libassuan}.tar.bz2   https://www.gnupg.org/ftp/gcrypt/libassuan/libassuan-${VERSION_libassuan}.tar.bz2
curl -s -L -o $ARTIFACT_DIR/ntbtls-${VERSION_ntbtls}.tar.bz2   https://www.gnupg.org/ftp/gcrypt/ntbtls/ntbtls-${VERSION_ntbtls}.tar.bz2
curl -s -L -o $ARTIFACT_DIR/npth-${VERSION_npth}.tar.bz2   https://www.gnupg.org/ftp/gcrypt/npth/npth-${VERSION_npth}.tar.bz2
curl -s -L -o $ARTIFACT_DIR/pinentry-${VERSION_pinentry}.tar.bz2   https://www.gnupg.org/ftp/gcrypt/pinentry/pinentry-${VERSION_pinentry}.tar.bz2


cd $ARTIFACT_DIR
rm -rf INSTALL
mkdir -p INSTALL/libgpg-error
mkdir -p INSTALL/libgcrypt
mkdir -p INSTALL/libksba
mkdir -p INSTALL/libassuan
mkdir -p INSTALL/ntbtls
mkdir -p INSTALL/npth
mkdir -p INSTALL/pinentry
mkdir -p INSTALL/gnupg

# ----
tar xf libgpg-error-${VERSION_libgpg_error}.tar.bz2
cd libgpg-error-$VERSION_libgpg_error
./configure --prefix=$(readlink -f ../INSTALL/libgpg-error) --enable-install-gpg-error-config
make install
cd -


# ----
tar xf libgcrypt-${VERSION_libgcrypt}.tar.bz2
cd libgcrypt-${VERSION_libgcrypt}
./configure --with-libgpg-error-prefix=$(readlink -f ../INSTALL/libgpg-error) --prefix=$(readlink -f ../INSTALL/libgcrypt)
make install
cd -


# ----
tar xf libksba-${VERSION_libksba}.tar.bz2
cd libksba-${VERSION_libksba}
./configure \
    --with-libgpg-error-prefix=$(readlink -f ../INSTALL/libgpg-error) \
    --prefix=$(readlink -f ../INSTALL/libksba)
make install
cd -

# ----
tar xf libassuan-${VERSION_libassuan}.tar.bz2
cd libassuan-${VERSION_libassuan}
./configure \
    --with-libgpg-error-prefix=$(readlink -f ../INSTALL/libgpg-error) \
    --prefix=$(readlink -f ../INSTALL/libassuan)
make install
cd -

# ----
tar xf ntbtls-${VERSION_ntbtls}.tar.bz2
cd ntbtls-${VERSION_ntbtls}
./configure \
    --with-libgpg-error-prefix=$(readlink -f ../INSTALL/libgpg-error) \
    --with-libgcrypt-prefix=$(readlink -f ../INSTALL/libgcrypt) \
    --with-kbsa-prefix=$(readlink -f ../INSTALL/libksba) \
    --with-libassuan-prefix=$(readlink -f ../INSTALL/libassuan) \
    --prefix=$(readlink -f ../INSTALL/ntbtls)
make install
cd -


# ----
tar xf pinentry-${VERSION_pinentry}.tar.bz2
cd pinentry-${VERSION_pinentry}
./configure \
    --with-libgpg-error-prefix=$(readlink -f ../INSTALL/libgpg-error) \
    --with-libassuan-prefix=$(readlink -f ../INSTALL/libassuan) \
    --prefix=$(readlink -f ../INSTALL/pinentry)
make install
cd -

tar xf npth-${VERSION_npth}.tar.bz2
cd npth-${VERSION_npth}
./configure  --prefix=$(readlink -f ../INSTALL/npth) --enable-install-npth-config
make install
cd -


tar xf gnupg-${ARTIFACT_VERSION}.tar.bz2
cd gnupg-${ARTIFACT_VERSION}
./configure \
    --with-libgpg-error-prefix=$(readlink -f ../INSTALL/libgpg-error) \
    --with-libgcrypt-prefix=$(readlink -f ../INSTALL/libgcrypt) \
    --with-ksba-prefix=$(readlink -f ../INSTALL/libksba) \
    --with-libassuan-prefix=$(readlink -f ../INSTALL/libassuan) \
    --with-npth-prefix=$(readlink -f ../INSTALL/npth) \
    --prefix=$(readlink -f ../INSTALL/gnupg)
make install
cd -
