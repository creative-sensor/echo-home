"-------- [GLOBAL] --------
set shada-=!
let g:yaml_revealer_separator='âž¤'
    "<C-v>u27a4
let g:font_name = "Consolas"
let g:font_size = 11
"-------- [GLOBAL] -------- GML
let g:GML_PROMPT = empty($GML_PROMPT) ?  '~/.gml.prompt' : $GML_PROMPT
let g:GML_PROMPT_SSH = empty($GML_PROMPT_SSH) ?  '~/.gml.prompt' : $GML_PROMPT_SSH
let g:GML_MODEL = ""
let g:GML_MODEL_SSH = ""
let g:GMLBASE = empty($GMLBASE) ? '~/.lmstudio/models' : $GMLBASE
let g:GMLBASE_SSH = empty($GMLBASE_SSH) ? '~/.lmstudio/models' : $GMLBASE_SSH
let g:GML_DEV = empty($GML_DEV) ? 'Vulkan0' : $GML_DEV
"-------- [GLOBAL] -------- SSH
let g:SSH_ALIAS = empty($SSH_ALIAS) ? "" : $SSH_ALIAS
"-------- [GLOBAL] -------- MIMD
let g:MIMD_BASE = empty($MIMD_BASE) ? '~/echo-home/.vim/mimd' : $MIMD_BASE

"-------- [MISC] --------
syntax on
highlight CursorLine cterm=NONE ctermbg=251
    "highlight CursorLine cterm=NONE ctermbg=24
filetype on



"-------- [VARSET] --------
set laststatus=2
set ruler
set cursorline
set hlsearch
set nowrap
set expandtab
set tabstop=4
set guicursor=a:blinkon100
set splitright
set paste
set title titlestring=VIM\ \|\ %{fnamemodify(getcwd(),\ ':t')} titlelen=32
    "output:  VIM | current_dirname
set background=light
set shell=~/.local/bin/bash
set shellcmdflag=-c
set shellxquote=" "
set shellslash
"set shellredir=>
set backspace=indent,eol,start
set ff=unix
set foldlevelstart=10




"-------- [GUI / NEOVIDE] --------
if exists('g:neovide')
  let g:neovide_cursor_animation_length = 0
  let g:neovide_cursor_vfx_mode = ""
  let g:neovide_scroll_animation_length = 0.001
  set guifont=SF\ Mono:h13
endif

"-------- [PLUGIN / VUNDLE] --------
set nocompatible              " be iMproved, required
filetype off                  " required
set rtp+=~/.vim/bundle/Vundle.vim
call vundle#begin()
Plugin 'VundleVim/Vundle.vim'
        "Plugin Manager
Plugin 'thaerkh/vim-workspace'
        "Workspace
Plugin 'jreybert/vimagit'
        "Git workflow
Plugin 'tpope/vim-fugitive'
        "Git commands
Plugin 'junegunn/gv.vim'
        "Git browser
Plugin 'lifepillar/vim-solarized8'
        "Colorscheme
Plugin 'jlanzarotta/bufexplorer'
        "Buffer Explorer
Plugin 'Einenlum/yaml-revealer'
        "echo yaml path'
Plugin 'pedrohdz/vim-yaml-folds'
Plugin 'Yggdroot/indentLine'
Plugin 'hashivim/vim-terraform'
Plugin 'equal-l2/vim-base64'
call vundle#end()            " required
filetype plugin indent on    " required

"-------- [PLUGIN / VIM-PLUG] --------
source ~/.vim/vim-plug/plug.vim
call plug#begin()
" List your plugins here
Plug 'nvim-tree/nvim-web-devicons'
Plug 'nvim-lua/plenary.nvim'
Plug 'nvim-lualine/lualine.nvim'
Plug 'nvim-telescope/telescope.nvim'
Plug 'shaunsingh/solarized.nvim'
if exists('g:neovide')
  Plug 'ellisonleao/gruvbox.nvim'
endif
Plug 'nanozuki/tabby.nvim'
call plug#end()



"-------- [FUNCTIONS] --------
function! AdjustFontSize(delta)
  let g:font_size += a:delta
  execute "set guifont=" . g:font_name . ":h" . g:font_size
endfunction


fun! FindJsonPath()
  " FIND JSON PATH
  let path_file = tempname()
  let @j = expand("%:p")
  exec '!find-jsonpath '.getreg('j').' > '.path_file
  exec 'vsplit '.path_file
  exec 'set filetype=yaml'
  call delete(path_file)
endfun
command! -nargs=0 Jpath call FindJsonPath()


fun! FindYamlPath()
  " FIND YAML PATH
  let path_file = tempname() . '.yaml'
  let @y = expand("%:p")
  exe '!find-yamlpath '.getreg('y').' > '.path_file
  exe 'vsplit '.path_file
  call delete(path_file)
endfun
command! -nargs=0 Ypath call FindYamlPath()


fun! FindGrep(filename)
  " FIND FILES AND POPULATE THE QUICKFIX LIST
  let error_file = tempname()
  exe '!find "./"| grep -i "'.a:filename.'" | xargs file | sed "s/:/:1:/" > '.error_file
  set errorformat=%f:%l:%m
  exe "cfile ". error_file
  copen
  call delete(error_file)
endfun
command! -nargs=1 FindGrep call FindGrep(<q-args>)


function FgXp(pattern, maxdepth=32)
  " FIELD GIT EXPLORER
  let error_file = tempname()
  exe '!find "./" -maxdepth ' . a:maxdepth . ' -type f | grep -v "^./.git" | grep -i "'  .  a:pattern  .  '" | sed "s/\$/:1/" > '.error_file
  set errorformat=%f:%l
  exe "cfile ". error_file
  copen
  call delete(error_file)
endfun
command! -nargs=* FgXp call FgXp(<q-args>)

function Base64e()
  " BASE64 ENCODING
  let file = bufname()
  exec "vnew ".file."__base64"
  exec 'silent read !base64 <'.file.'| tr -d -t "\n"'
endfunction

function EVsplitX(pattern,maxdepth=3)
  vsplit
  call FgXp(a:pattern,a:maxdepth)
endfunction
command! -nargs=* Evx call EVsplitX(<f-args>)


fun! GrepSource(text)
  " GREP SOURCE CODE WHICH CONTAINS TEXT
  " :Grin text  " open window of search results
  " CTRLw gf    " open file in new tab
  let error_file = tempname()
  exe '!grep -rin '.a:text.' >  '.error_file
  set errorformat=%f:%l:%m
  exe "cfile ". error_file
  copen
  call delete(error_file)
endfun
command! -nargs=1 Grin call GrepSource(<q-args>)






function ShellPython()
    set shell=python
    exec "below terminal"
    set shell=bash
endfunction


function ShellContainer(image="ubuntu:latest",cmd="bash --rcfile /dkr/rc")
	let color_ps1 = "Q09MT1JfQkc9J1xbXDAzM1s0ODs1OzkwbVxdJwpDT0xPUl9GRz0nXFtcMDMzWzM4OzU7MjUybVxdJwpTVE9QPSdcW1wwMzNbMG1cXScKClBTMT0iJHtDT0xPUl9CR30ke0NPTE9SX0ZHfVx1QFxoOlx3JHtTVE9QfSAiCg=="
	let envfile = ".env.".substitute(a:image, ":", "__", "")
	"if ! filereadable(envfile)
	"	let envfile = ".env"
	"endif
    silent exec '! touch '.envfile.'; test -z "$(<'.envfile.')" && echo PROMPT_COMMAND="\"cd /dkr/$(basename $(pwd));unset PROMPT_COMMAND\"" > '.envfile
    silent exec '! if tail -1 '.envfile '| grep -q ^PROMPT_COMMAND= ; then echo '.color_ps1.' | base64 -d >> '.envfile.' ; fi'
    exec 'below term docker run --rm --env-file '.envfile.' -v "$(pwd)/'.envfile.':/dkr/rc" -v "$(pwd):/dkr/$(basename $(pwd))" -it '.a:image.' '.a:cmd
endfunction
command! -nargs=1 ShellContainer call ShellContainer(<q-args>)


function SessionMgmt()
    let limit = 512
    "exec "! set -x ; rm $(find Session.vim -mtime +7)"
    silent exec "! [[ ".limit." -lt $(wc -l Session.vim  | awk '{print $1}') ]] && rm Session.vim"
endfunction

function StartUp()
endfunction


function YsonLine()
  normal! yy
  let yson_filename = bufname('%')
  let yson_bufnr = bufnr(yson_filename)
  let yson_winids = win_findbuf(yson_bufnr)

  let yson_line = yson_filename."_line.json"
  let bufnr = bufnr(yson_line)
  if bufnr != -1
    let winids = win_findbuf(bufnr)
    call win_gotoid(winids[0])
    execute '%delete _'
  else
    execute 'split '.yson_line 
  endif
  let command = "echo '".@"."' | yq -o json"
  let @" = system(command)
  normal! p
  call win_gotoid(yson_winids[0])
endfunction



"-------- [FUNCTIONS] -------- MIMD
function! VimPage_mimd()
    exec 'vsplit | enew | r!cd ~/echo-home/.vim/mimd; find . -type f'
    exec "0put ='### Mini Modules KM[mimds]'"
    exec "1put ='--------'"
    exec "$put ='' | $put ='--------'"
    exec 'set ft=markdown'
endfunction


"-------- [FUNCTIONS] -------- AttentionFlash
function! GML_ModelEngage()
    exec 'vsplit | enew | r!cd '.g:GMLBASE.';find  -type f'
    exec "0put ='### LLM-MODELS KM[gmex,gmep]'"
    exec "1put ='--------'"
    exec "$put ='' | $put ='--------'"
    exec 'set ft=markdown'
    if !empty(g:SSH_ALIAS)
      exec 'split | enew | r!ssh '.g:SSH_ALIAS.' "cd '.g:GMLBASE_SSH.';find . -type f"'
      exec "0put ='### LLM-MODELS KM[gmes,gmep]  SSH[".g:SSH_ALIAS."]'  "
      exec "1put ='--------'"
      exec "$put ='' | $put ='--------'"
      exec 'set ft=markdown'
    endif
endfunction

function! AttentionFlashUMA(edit=0)
    let GML_MODEL = empty($GML_MODEL) ? g:GML_MODEL : $GML_MODEL
    if a:edit
      silent exec "vsplit ".g:GML_PROMPT
      normal G
      let pnote = input("Prompt note: ")
      put =pnote
      write
      bd
    endif
    exec 'vsplit'
    exec 'term llama-cli -st  --no-kv-offload  -m '.GML_MODEL.' -f '.g:GML_PROMPT
    exec 'set ft=markdown'
endfunction

function! AttentionFlashSSH(edit=0)
    let GML_MODEL = empty($GML_MODEL_SSH) ? g:GML_MODEL_SSH : $GML_MODEL_SSH
    if a:edit
      silent exec "vsplit ".g:GML_PROMPT
      normal G
      let pnote = input("Prompt note: ")
      put =pnote
      write
      bd
    endif
    exec '!cat '.g:GML_PROMPT.'| ssh '.g:SSH_ALIAS.' "cat > '.g:GML_PROMPT.'"'
    exec 'vsplit'
    exec 'term ssh '.g:SSH_ALIAS.' "llama-cli -st  --n-gpu-layers 0 --no-kv-offload  -m '.GML_MODEL.' -f '.g:GML_PROMPT.'"'
    exec 'set ft=markdown'
endfunction


"-------- [AUTOCMD] --------
autocmd FileType yaml  : set tabstop=2
"autocmd VimEnter * above terminal ++rows=7
"autocmd VimEnter * if isdirectory(".git") | silent call FgXp(".") | endif
autocmd VimEnter * silent call SessionMgmt()
"autocmd TerminalOpen * set termwinsize=0*0
    "termwinsize: auto-adjustable
autocmd InsertEnter * highlight CursorLine ctermbg=190 guibg=#D5EE16 | highlight StatusLine ctermbg=190 guibg=#CCFF00
"autocmd InsertLeave * highlight CursorLine ctermbg=254 guibg=#D32075  | highlight StatusLine ctermbg=254 guibg=#eee8d5
autocmd InsertLeave * highlight CursorLine ctermbg=254 guibg=#dadeaf  | highlight StatusLine ctermbg=254 guibg=#eee8d5



"-------- [KEYMAP] --------
map tff : Telescope find_files <CR>
map tgr : Telescope grep_string <CR>
map ys : call YsonLine() <CR>
map tsm : tabs <CR>
map T : tabnew . <CR>
    "New tab
map C : s/^/#/<CR>
    "Comment
map uc : s/^#//<CR>
    "Uncomment
map Bp : bp<CR>
    "Buffer back
map Bn : bn<CR>
    "Buffer next
map aC : :%!column -t<CR>
    "Format as columns
map WW : wa<CR>
    "Save all
map QQ : wqa<CR>
    "Save and quit all
map q0 : qa!<CR>
    "Quit all
map q1 : q!<CR>
    "Quit current

map tty : highlight Terminal ctermbg=23 ctermfg=15 guibg=#073042 guifg=#7ec1de \| below terminal <CR>
map tth : below term cd %:p:h; $LOCAL_BIN/bash <CR>

map e3 : vsplit \| call FgXp(".",3)<CR>
map e6 : vsplit \| call FgXp(".",6)<CR>
map e9 : vsplit \| call FgXp(".",9)<CR>
    "List file at maxdepth=X

map i0 : echo expand('%:p') <CR>
map f5 : edit <CR>
map e/ : edit . <CR>
map e. : edit %:p:h <CR>
map t/ : tabnew . <CR>
map t. : tabnew %:p:h <CR>
map s/ : split . <CR>
map s. : split %:p:h <CR>
map v/ : vsplit . <CR>
map v. : vsplit %:p:h <CR>
map dfe : diffoff! <CR>
map dff : windo diffthis<CR>
map dfg : diffget<CR>
map b64 : call Base64e()<CR>
map dex : Git <CR>tty<CR><C-w>L<C-w>=
map hls : set hls!<CR>
map sua : %sort u<CR>
map \date :execute "normal! i" . substitute(system('date -u "+%Y-%m-%dT%H-%M-%SZ"'), '\n$', '', '')<CR>
map \uuid :execute "normal! i" . substitute(system('uuidgen'), '\n$', '', '')<CR>
map .ys : .!yq -P -I 4<CR>
vmap b64    \atob<Esc>
vmap b94    \btoa<Esc>



map src : source ~/.vimrc.neo<CR>


nnoremap cup : Git commit -m "up"<CR>

vnoremap ccp    "+y
vnoremap ===    "+y : vsplit <CR> : Grin <C-R>+ <CR>
    "LOOK UP KEYWORD
    ":copy selected text into register '+'
    ":vertical split window
    ":and call function Grin which take
    "content of '+' as argument

vnoremap --    "+y : vsplit <C-R>+ <CR>
    "JUMP TO PATH

nnoremap <F5><F5> : edit<CR>


" Map keys to increase/decrease font size
nnoremap <C-0> :call AdjustFontSize(1)<CR>
nnoremap <C-9> :call AdjustFontSize(-1)<CR>

"-------- [KEYMAP] -------- MIMD
map mimd : call VimPage_mimd()<CR>
map mimds : let g_line = getline('.')<CR>:exec 'source '.g:MIMD_BASE."/".g_line<CR>:$put ='LOADED: '.g_line<CR>

"-------- [KEYMAP] -------- SSH
map sshc : tabnew ~/.ssh/config<CR>
map sshcx : let g:SSH_ALIAS = substitute(getline('.'), '^Host \+', '', 'g')<CR>
map ssh : exec "below term ssh ".g:SSH_ALIAS<CR>
"-------- [KEYMAP] -------- GML
map afu : .w! <C-R>=g:GML_PROMPT<CR><CR>:call AttentionFlashUMA()<CR>
map afue : .w! <C-R>=g:GML_PROMPT<CR><CR>:call AttentionFlashUMA(1)<CR>
map afcs : .w! <C-R>=g:GML_PROMPT<CR><CR>:call AttentionFlashSSH()<CR>
map afces : .w! <C-R>=g:GML_PROMPT<CR><CR>:call AttentionFlashSSH(1)<CR>
map afdd : %w! <C-R>=g:GML_PROMPT<CR><CR>:call AttentionFlashUMA()<CR>
map afdde : %w! <C-R>=g:GML_PROMPT<CR><CR>:call AttentionFlashUMA(1)<CR>
map gme : call GML_ModelEngage()<CR>
map gmep : let GML_xPrompt = tempname()<CR>:exec 'split '.GML_xPrompt.'{xPrompt}'<CR>:set wrap<CR>
map gmex : let g:GML_MODEL = g:GMLBASE."/".getline('.')<CR>:$put ='```Engaged``` '.g:GML_MODEL<CR>
map gmes : let g:GML_MODEL_SSH = g:GMLBASE_SSH."/".getline('.')<CR>:$put ='```Engaged[ssh]``` '.g:GML_MODEL_SSH<CR>

"-------- [LUA-INIT] --------
set rtp+=~/.vim/lua
lua require("neo-init")


"-------- [POST-INIT] --------
if exists('g:neovide')
"  colorscheme solarized
  colorscheme gruvbox
else
  colorscheme solarized8_high
endif

