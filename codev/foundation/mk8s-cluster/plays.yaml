- name: CONSTRUCT 3-WORKER MICRO-K8S CLUSTER
  hosts: mk8s_cluster
  tasks:
    - name: INSTALL MK8S
      shell: |
        sudo snap install microk8s --classic --channel=1.16/stable
        sudo usermod -a -G microk8s $USER


- name: GENERATE JOIN CMD
  hosts: master
  tasks:
    - name: print join cmd
      shell: |
              sleep 5
              export PATH=$PATH:/snap/bin
              for i in {1..3}; do
                  sudo microk8s.add-node | head -1 | grep -o microk8s.*
              done
      args:
          executable: /bin/bash
      register: JOIN_CMD
      delegate_to: master
    - debug: msg="{{JOIN_CMD.stdout_lines}}"


- name: ADD NODE TO CLUSTER
  hosts:
      - worker_1
      - worker_2 
      - worker_3
  tasks:
    - name: Join run
      shell: |
             export PATH=$PATH:/snap/bin
             {{ hostvars['master']['JOIN_CMD'].stdout_lines[item] }}
                 # run join command generated by master node
      when: id == {{ item + 1 }}
          # id defined in inventory file
      loop:
        - 0
        - 1
        - 2
